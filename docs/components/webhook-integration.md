# GMAO Webhook Integration

This document provides an overview of the GMAO webhook integration within the Master Control Program (MCP). This integration allows the AI-AGENTS system to receive incident data from an external GMAO system, process it, and forward it to the Incident Analysis Agent for further analysis.

## 1. API Endpoint Details

The MCP exposes the following endpoint to receive incident data from the GMAO system:

-   **URL:** `/api/v1/webhooks/gmao/incidents`
-   **Method:** `POST`

## 2. Authentication

The webhook endpoint is secured using an API key. The calling GMAO system must include this API key in the request header:

-   **Header Name:** `X-GMAO-Token`
-   **Value:** The secret API key configured in the MCP.

If the token is missing or invalid, the MCP will respond with a `401 Unauthorized` or `403 Forbidden` status code, respectively. This is handled by the `verify_api_key` dependency in `mcp/api/endpoints.py`.

## 3. Expected Payload Format

The endpoint expects a JSON payload conforming to the `GmaoWebhookPayload` Pydantic model, defined in `mcp/models/webhook.py`.

Key fields include:
-   `external_incident_id` (str, required): Unique ID from GMAO.
-   `title` (str, required): Incident title.
-   `description` (str, required): Detailed incident description.
-   `status` (str, required): Current status in GMAO.
-   `priority` (str, required): Priority from GMAO (e.g., "LOW", "MEDIUM", "HIGH").
-   `incident_created_at` (datetime, required): Timestamp of creation in GMAO.
-   `affected_services` (Optional[List[str]]): List of affected services.
-   `reported_by_gmao_user_id` (Optional[str]): Reporter ID from GMAO.
-   `gmao_link` (Optional[str]): Link to the incident in GMAO.
-   `additional_data` (Optional[Dict[str, Any]]): Other key-value pairs.

For a complete schema and example, please refer to `mcp/models/webhook.py`.

```python
# Example GmaoWebhookPayload (from mcp/models/webhook.py)
class GmaoWebhookPayload(BaseModel):
    external_incident_id: str = Field(..., description="Unique ID of the incident from the GMAO system (e.g., Django model\'s id).", json_schema_extra={\"example\":\"123\"})
    title: str = Field(..., description=\"Title of the incident.\", json_schema_extra={\"example\":\"Network Outage in Building A\"})
    # ... (other fields as defined in the model) ...
    additional_data: Optional[Dict[str, Any]] = Field(default_factory=dict, description=\"Any other relevant key-value pairs from GMAO.\")
```

## 4. Response Format and Status Codes

Upon receiving a request:

-   **Successful Reception:**
    -   **Status Code:** `202 Accepted`
    -   **Response Body:** A JSON object conforming to the `WebhookResponse` model (defined in `mcp/models/webhook.py`), including:
        -   `status` (str): e.g., "success"
        -   `message` (str): e.g., "Incident received and queued for processing."
        -   `tracking_id` (str): A unique ID generated by MCP to trace the processing of this specific webhook event.
        ```python
        # Example WebhookResponse (from mcp/models/webhook.py)
        class WebhookResponse(BaseModel):
            status: str = Field(..., json_schema_extra={\"example\":\"success\"}, description=\"Indicates the outcome of the webhook reception.\")
            message: str = Field(..., json_schema_extra={\"example\":\"Incident received and queued for processing.\"}, description=\"A human-readable message about the status.\")
            tracking_id: Optional[str] = Field(None, description=\"An optional ID to track the processing of this webhook event internally.\", json_schema_extra={\"example\":\"mcp-webhook-proc-xyz789\"})
        ```
-   **Authentication Errors:**
    -   `401 Unauthorized`: If the `X-GMAO-Token` header is missing.
    -   `403 Forbidden`: If the `X-GMAO-Token` is invalid.
-   **Payload Validation/Mapping Errors:**
    -   `422 Unprocessable Entity`: If the incoming payload fails Pydantic validation against `GmaoWebhookPayload` or if there's a critical error during the initial data mapping phase (before background task queuing).

## 5. Data Transformation Flow

The received `GmaoWebhookPayload` is transformed into the internal `IncidentReport` model (defined in `agents/incident/models.py`) before being forwarded to the Incident Analysis Agent. This transformation is handled by the `map_gmao_to_incident_report` function in `mcp/api/endpoints.py`.

Key transformations include:
-   Mapping GMAO's text-based priority (e.g., "HIGH") to an internal integer representation.
-   Consolidating various fields from the GMAO payload (title, description, status, links, additional data) into a comprehensive `description` field for the `IncidentReport`.

```python
# Snippet from map_gmao_to_incident_report in mcp/api/endpoints.py
def map_gmao_to_incident_report(gmao_payload: GmaoWebhookPayload) -> IncidentReport:
    # ... priority mapping ...
    # ... description construction ...
    report = IncidentReport(
        incident_id=gmao_payload.external_incident_id,
        timestamp=gmao_payload.incident_created_at,
        description=full_description,
        priority=internal_priority,
        affected_systems=gmao_payload.affected_services,
        reporter=gmao_payload.reported_by_gmao_user_id
    )
    return report
```

## 6. Asynchronous Processing

To ensure the webhook endpoint responds quickly, the actual forwarding of the mapped `IncidentReport` to the Incident Analysis Agent is handled as an asynchronous background task.

-   **Mechanism:** FastAPI's `BackgroundTasks` is used.
-   **Task Function:** `forward_incident_to_agent` (in `mcp/api/endpoints.py`) is scheduled to run in the background.
-   The `tracking_id` generated upon webhook reception is passed to this background task for consistent logging and traceability.

```python
# Snippet from receive_gmao_incident in mcp/api/endpoints.py
async def receive_gmao_incident(
    payload: GmaoWebhookPayload, 
    background_tasks: BackgroundTasks,
    # ...
):
    tracking_id = f"mcp-wh-{uuid.uuid4()}"
    # ...
    incident_report_data = map_gmao_to_incident_report(payload)
    # ...
    background_tasks.add_task(forward_incident_to_agent, incident_report_data, tracking_id)
    # ...
    return WebhookResponse(...)
```

## 7. Error Handling and Retry Mechanism

The `forward_incident_to_agent` background task incorporates error handling and a retry mechanism when communicating with the Incident Analysis Agent:

-   **Client Timeout:** The `httpx.AsyncClient` used to POST to the Incident Analysis Agent has a configured timeout of 120 seconds.
-   **Retry Attempts:** If communication fails due to a network error (`httpx.RequestError`) or a server-side error from the agent (`5xx HTTPStatusError`), the MCP will retry the request.
    -   `MAX_FORWARD_ATTEMPTS`: 3 (total attempts)
    -   `RETRY_DELAYS_SECONDS`: `[5, 10]` (5s after 1st failure, 10s after 2nd failure)
-   **Non-Retryable Errors:** Client-side errors (`4xx HTTPStatusError`) from the agent are not retried.
-   **Logging:** All attempts, errors, and retries are logged with the unique `tracking_id` associated with the webhook event.

```python
# Snippet from forward_incident_to_agent in mcp/api/endpoints.py
async def forward_incident_to_agent(incident_report: IncidentReport, tracking_id: str):
    # ...
    for attempt in range(1, MAX_FORWARD_ATTEMPTS + 1):
        try:
            async with httpx.AsyncClient(timeout=120.0) as client:
                # ... POST request ...
                response.raise_for_status()
                return # Success
        except httpx.RequestError as e:
            # ... log warning/error ...
        except httpx.HTTPStatusError as e:
            if e.response.status_code >= 500:
                # ... log warning/error for 5xx ...
            else:
                # ... log error for 4xx and return ...
        except Exception as e:
            # ... log unexpected error ...
        
        if attempt < MAX_FORWARD_ATTEMPTS:
            # ... await asyncio.sleep(delay) ...
    
    logger.error(f"[{tracking_id}] All {MAX_FORWARD_ATTEMPTS} attempts ... failed.")
```

## 8. Configuration Requirements

The following environment variables need to be configured for the MCP service (e.g., in `.env` or `docker-compose.yml`):

-   `GMAO_WEBHOOK_API_KEY`: The secret API key that the GMAO system must send in the `X-GMAO-Token` header for authentication.
    -   *Example:* `GMAO_WEBHOOK_API_KEY="your-secure-api-key-here"`
-   `INCIDENT_AGENT_URL`: The full URL to the Incident Analysis Agent's `/api/analyze` endpoint.
    -   *Example:* `INCIDENT_AGENT_URL="http://incident-agent:8003/api/analyze"`

Additionally, the `incident-agent` service relies on the `LLM_REQUEST_TIMEOUT` environment variable (configured in `docker-compose.yml`) for its calls to the `llm-service`. While not directly part of the webhook configuration, it's crucial for the end-to-end processing initiated by the webhook.

## 9. Example `curl` Command for Testing

```bash
# Ensure you have a valid date for incident_created_at
# Replace YOUR_MCP_HOST, YOUR_GMAO_TOKEN, and other placeholders as needed.
INCIDENT_TIMESTAMP=$(date -u +%Y-%m-%dT%H:%M:%SZ)

curl -X POST http://YOUR_MCP_HOST:8002/api/v1/webhooks/gmao/incidents \\
-H "Content-Type: application/json" \\
-H "X-GMAO-Token: YOUR_GMAO_TOKEN" \\
-d '{
  "external_incident_id": "GMAO-INT-TEST-CURL-001",
  "title": "Test via Curl: Webhook System Check",
  "description": "This is a test incident submitted via curl to verify the GMAO webhook endpoint.",
  "status": "NEW",
  "priority": "LOW",
  "incident_created_at": "'"$INCIDENT_TIMESTAMP"'",
  "affected_services": ["TestServiceA", "TestServiceB"],
  "reported_by_gmao_user_id": "curl_tester",
  "image_url": null,
  "gmao_link": "http://gmao.example.com/incidents/GMAO-INT-TEST-CURL-001",
  "additional_data": {
    "source_tool": "curl",
    "test_case_id": "TC-WH-001"
  }
}'
```

## 10. Architecture Diagram Reference

The GMAO webhook integration is part of the overall system architecture. Refer to `docs/architecture.md` and any relevant diagrams in `docs/architecture/diagrams/` for a visual representation of how this component interacts with others, particularly its role as an ingress point for incidents into the MCP. 